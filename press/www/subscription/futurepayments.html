

<link rel="stylesheet" href="/assets/press/subscription/stripe.css" />
<script src="https://js.stripe.com/v3/"></script>


<div class="sr-root">
    <div class="sr-main">
    <div class="sr-payment-summary payment-view">
        <h4>Frappe Cloud subscription</h4>
    </div>
    <form>
        <div class="sr-payment-form payment-view">
        <div class="sr-form-row">
            <label for="card-element">
            Payment details
            </label>
            <div class="sr-combo-inputs">
            <div class="sr-combo-inputs-row">
                <input
                type="text"
                id="email"
                placeholder="Email"
                autocomplete="cardholder"
                class="sr-input"
                />
            </div>
            <div class="sr-combo-inputs-row">
                <div class="sr-input sr-card-element" id="card-element"></div>
            </div>
            </div>
            <div class="sr-field-error" id="card-errors" role="alert"></div>
        </div>

        <button id="submit">
            <div id="spinner" class="hidden"></div>
            <span id="button-text">Subscribe</span>
        </button>
        <div style='margin-top: 10px;text-align: center;'>
                <h4>By confirming your subscription, you allow Frappe Cloud to charge your card for future payments in accordance with their terms.</h4>
        </div>
        </div>
    </form>
    <div class="sr-payment-summary hidden completed-view">
        <h1>Your subscription is <span class="order-status"></span></h1>
    </div>
    </div>
</div>
<script>

frappe.ready(function(){
    var stripe;

    var stripeElements = function(publicKey) {
        stripe = Stripe(publicKey);
        var elements = stripe.elements();

        // Element styles
        var style = {
            base: {
            fontSize: '16px',
            color: '#32325d',
            fontFamily:
                '-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif',
            fontSmoothing: 'antialiased',
            '::placeholder': {
                color: 'rgba(0,0,0,0.4)'
            }
            }
        };

        var card = elements.create('card', { style: style });

        card.mount('#card-element');

        // Element focus ring
        card.on('focus', function() {
            var el = document.getElementById('card-element');
            el.classList.add('focused');
        });

        card.on('blur', function() {
            var el = document.getElementById('card-element');
            el.classList.remove('focused');
        });

        document.querySelector('#submit').addEventListener('click', function(evt) {
            evt.preventDefault();
            changeLoadingState(true);
            // Initiate payment
            createPaymentMethodAndCustomer(stripe, card);
        });
    };

    function getPublicKey() {
        frappe.call({
            method: "press.www.subscription.futurepayments.get_public_key",
            callback: function(r){
                return stripeElements(r.message.publishable_key);
            }
        })

    }

    getPublicKey();

    function showCardError(error) {
        changeLoadingState(false);
        // The card was declined (i.e. insufficient funds, card has expired, etc)
        var errorMsg = document.querySelector('.sr-field-error');
        errorMsg.textContent = error.message;
        setTimeout(function() {
            errorMsg.textContent = '';
        }, 8000);
    }

    var createPaymentMethodAndCustomer = function(stripe, card) {
        var cardholderEmail = document.querySelector('#email').value;
        stripe
            .createPaymentMethod('card', card, {
                billing_details: {
                    email: cardholderEmail
                }
            })
            .then(function(result) {
                if (result.error) {
                    showCardError(result.error);
                } else {
                    createCustomer(result.paymentMethod.id, cardholderEmail);
                }
            });
    };

    async function createCustomer(paymentMethod, cardholderEmail) {
        frappe.call({
            method: "press.www.subscription.futurepayments.create_customer_and_subscription",
            args: {
                email: cardholderEmail,
                payment_method: paymentMethod
            },
            callback: function(r){
                handleSubscription(r.message.subscription);
            }
        })
    }

    function handleSubscription(subscription) {
        const { future_intent } = subscription;

        if (future_intent) {
            const { client_secret, status } = future_intent;

            if (status === 'requires_action') {
                stripe.confirmCardSetup(client_secret).then(function(result) {
                    if (result.error) {
                        // Display error message in your UI.
                        // The card was declined (i.e. insufficient funds, card has expired, etc)
                        changeLoadingState(false);
                        showCardError(result.error);
                    } else {
                        // Show a success message to your customer
                        orderComplete(subscription);
                    }
                });
            } else {
                // No additional information was needed
                // Show a success message to your customer
                orderComplete(subscription);
            }
        } else {
            orderComplete(subscription);
        }
    }

    /* ------- Post-payment helpers ------- */

    /* Shows a success / error message when the payment is complete */
    var orderComplete = function(subscription) {
        changeLoadingState(false);
        var subscriptionJson = JSON.stringify(subscription, null, 2);
        document.querySelectorAll('.payment-view').forEach(function(view) {
            view.classList.add('hidden');
        });
        document.querySelectorAll('.completed-view').forEach(function(view) {
            view.classList.remove('hidden');
        });
        document.querySelector('.order-status').textContent = subscription.status;
    };

    // Show a spinner on subscription submission
    var changeLoadingState = function(isLoading) {
        if (isLoading) {
            document.querySelector('#spinner').classList.add('loading');
            document.querySelector('button').disabled = true;

            document.querySelector('#button-text').classList.add('hidden');
        } else {
            document.querySelector('button').disabled = false;
            document.querySelector('#spinner').classList.remove('loading');
            document.querySelector('#button-text').classList.remove('hidden');
        }
    };

})

</script>

<!-- CSS and JS reference from https://github.com/stripe-samples/set-up-subscriptions -->